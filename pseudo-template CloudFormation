AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Arquitectura de microservicios para un sistema documental en la nube,
  modelada mediante AWS CloudFormation como apoyo a la evaluaci贸n
  arquitect贸nica con AWS Well-Architected Framework.

Resources:

  ApiGatewayDocumentos:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: SistemaDocumentalAPI
      Description: API de acceso al sistema de gesti贸n documental

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaGestionDocumentosRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  GestionDocumentosFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: GestionDocumentos
      Runtime: python3.10
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 512
      Description: >
        Microservicio encargado del registro, versionado,
        consulta y eliminaci贸n de documentos.

  DocumentosBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: sistema-documental-archivos
      VersioningConfiguration:
        Status: Enabled

  MetadataDocumentosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: MetadataDocumentos
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: idDocumento
          AttributeType: S
      KeySchema:
        - AttributeName: idDocumento
          KeyType: HASH

  AuditoriaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AuditoriaDocumentos
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: idAuditoria
          AttributeType: S
      KeySchema:
        - AttributeName: idAuditoria
          KeyType: HASH

  NotificacionesTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: AlertasDocumentales
